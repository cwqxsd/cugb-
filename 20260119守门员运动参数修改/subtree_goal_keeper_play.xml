


<root BTCPP_format="4" >
   <include path="./subtree_cam_find_and_track_ball.xml" />
   <include path="./subtree_find_ball.xml" />
   <include path="./subtree_locate.xml" />
   
   <BehaviorTree ID="GoalKeeperPlay">
      <ReactiveSequence >
         <SelfLocate mode="trust_direction" />
         
         <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />
         
         <ReactiveSequence _while="wait_for_opponent_kickoff" name="等待对方开球">
            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
            <SetVelocity />
         </ReactiveSequence>
         
         <ReactiveSequence _while="!wait_for_opponent_kickoff" name="已方开球或对方已经开球">
            <Sequence _while="ball_out">
               <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
               <GoBackInField />
               
               <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />
            </Sequence>
            
            <ReactiveSequence _while="!ball_out">
               <ReactiveSequence _while="wait_for_opponent_kickoff" name="等待对方开球">
                  <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                  <SetVelocity />
               </ReactiveSequence>
               <Sequence _while="!wait_for_opponent_kickoff" name="正常比赛">
                  <Sequence>
                     <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                     <GoalieDecide decision_out="{decision}" decision_in="{decision}" chase_threshold="3.0"/>
                     
                     <GoToGoalBlockingPosition _while="decision=='find'" theta_tolerance="0.3" />
                     <GoToGoalBlockingPosition _while="decision == 'retreat'" theta_tolerance="0.3" />
                     
                     <Chase   _while="decision == 'chase'"  vx_limit="1.9"  vy_limit="0.5"  vtheta_limit="4.0"  dist="0.1" safe_dist="0.5" />
                        <!--前进速度 (vx_limit)：0.8->1.9 (提升 237%);旋转速度 (vtheta_limit)：1.0->4.0 (提升 400%);横移速度 (vy_limit)：0.3->0.5 (提升 66%)-->
                     <Adjust _while="decision =='adjust'" turn_threshold="0.5" range="0.1" vx_limit="0.7" vy_limit="0.5" vtheta_limit="3.0" vtheta_factor="5.5" tangential_speed_far="0.9" tangential_speed_near="0.15" />
                        <!--将角度容差降至0.5、距离容差降至0.1，强制机器人必须贴身且正对球门；通过限制横移速度（0.5）并大幅提升旋转上限（3.0）与增益（5.5），逼迫机器人优先转身而非侧滑，彻底消除“螃蟹步”；同时降低近距离绕球速度（0.15）以确保击球方向的精准稳定。>
                     <Kick _while="decision == 'kick'" speed_limit="1.5" min_msec_kick="800"/>
                  </Sequence>
               </Sequence>
            </ReactiveSequence>
         </ReactiveSequence>
      </ReactiveSequence>
   </BehaviorTree>
</root>